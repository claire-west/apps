<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twitch Stream Utility</title>
    <link rel="icon" href="http://www.twitch.tv/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/foundation-icons/3.0/foundation-icons.min.css" rel="stylesheet" />
</head>
<body>
<nav class="top-bar" style="margin-bottom:0.9375rem;">
    <div class="top-bar-left">
        <ul class="dropdown menu" data-dropdown-menu>
            <li class="menu-text hide-for-small-only">Twitch Stream Utility</li>
            <li>
                <div class="input-group" style="margin-bottom: 0;">
                    <button id="security" class="button secondary" data-toggle="securityDropdown" style="margin-bottom: 0; padding: 0.3rem 1rem;">
                        <i class="fi-shield" style="font-size: 1.7rem;"></i>
                        <span class="show-for-sr">Security Warning</span>
                    </button>
                    <div class="dropdown-pane" id="securityDropdown" data-dropdown>
                        <p style="margin-bottom:0;"><strong>Security Notice:</strong>&nbsp;This tool involves running a batch file located on your computer. When you click a link using the custom protocol it will run this script.</p>
                        <p>While unlikely, if you click a link elsewhere that also uses the same protocol it is possible someone could take advantage of this.</p>
                    </div>
                    <button id="setup" class="button secondary" data-open="setupReveal" style="margin-bottom: 0; padding: 0.3rem 1rem; border-left: 1px solid white;">
                        <i class="fi-info" style="font-size: 1.7rem;"></i>
                        <span class="show-for-sr">Setup Instructions</span>
                    </button>
                    <div id="setupReveal" class="reveal" data-reveal>
                        <h5>Setup</h5>
                        <h6><strong>Prerequisites</strong></h6>
                        <ul style="background-color:white;">
                            <li><a href="http://www.videolan.org/vlc/index.html">VLC</a></li>
                            <li><a href="http://docs.livestreamer.io/">Livestreamer</a></li>
                        </ul>
                        <h6 style="margin-top:0.5rem;"><strong>launch.bat</strong></h6>
                        <code>set "str=%1</code><br />
                        <code>set "var2=%str:*:=%"</code><br />
                        <code>livestreamer twitch.tv/%var2%</code><br />
                        <h6 style="margin-top:0.5rem;"><strong>Protocol Setup</strong></h6>
                        <ol>
                            <li>In regedit, find HKEY_CLASSES_ROOT</li>
                            <li>Add a key named "livestreamer"</li>
                            <li>Set livestreamer's default string to "URL:Livestreamer Protocol"</li>
                            <li>Add an empty string to livestreamer called "URL Protocol"</li>
                            <li>Add a key to livestreamer named "shell"</li>
                            <li>Add a key to shell named "open"</li>
                            <li>Add a key to open named "command"</li>
                            <li>Set command's default string to the path of launch.bat (see below)</li>
                        </ol>
                        <p style="margin-top:0.5rem;margin-bottom:0.5rem;">The final structure should look like this:</p>
                        <p style="margin-bottom:0;">HKEY_CLASSES_ROOT</p>
                        <p style="margin-bottom:0;text-indent:1rem;">livestreamer</p>
                        <p style="margin-bottom:0;text-indent:2rem;">(Default) = "URL:Livestreamer Protocol"</p>
                        <p style="margin-bottom:0;text-indent:2rem;">URL Protocol = ""</p>
                        <p style="margin-bottom:0;text-indent:2rem;">shell</p>
                        <p style="margin-bottom:0;text-indent:3rem;">open</p>
                        <p style="margin-bottom:0;text-indent:4rem;">command</p>
                        <p style="margin-bottom:0;text-indent:5rem;">(Default) = "C:\...\launch.bat" "%1"</p>
                        <button class="close-button" data-close aria-label="Close modal" type="button">
                            <i class="fi-x"></i>
                            <span class="show-for-sr">Close</span>
                        </button>
                    </div>
                    <button class="button secondary" data-toggle="settingsDropdown" style="margin-bottom: 0; padding: 0.3rem 1rem; border-left: 1px solid white;">
                        <i class="fi-wrench" style="font-size: 1.7rem;"></i>
                        <span class="show-for-sr">Settings</span>
                    </button>
                    <div class="dropdown-pane" id="settingsDropdown" data-dropdown>
                        <div class="input-group">
                            <label for="quality" class="input-group-label">Quality</label>
                            <select id="quality" class="input-group-field">
                                <option value="best">Best</option>
                                <option value="source">Source</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="mobile">Mobile</option>
                                <option value="audio">Audio</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="autoRefresh" class="input-group-label" style="width: 226px;">Refresh every 2 minutes</label>
                            <input type="checkbox" id="autoRefresh" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label for="twelveHour" class="input-group-label" style="width: 226px;">12-hour time</label>
                            <input type="checkbox" id="twelveHour" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
                        </div>
                    </div>
                    <button class="button" data-open="singleStreamReveal" style="margin-bottom: 0; padding: 0.3rem 1rem; border-left: 1px solid white;">
                        <i class="fi-play-video" style="font-size: 1.7rem;"></i>
                        <span class="show-for-sr">Specify a Stream</span>
                    </button>
                    <div  id="singleStreamReveal" class="reveal" data-reveal>
                        <div class="input-group" style="margin-bottom:0;">
                            <label for="channelName" class="input-group-label">Channel</label>
                            <input type="text"id="channelName" class="input-group-field" placeholder="Channel Name" style="text-align:center;width:100%;" />
                            <div class="input-group-button">
                                <a id="checkSingleStream" class="button primary disabled" style="width:8.1rem;margin-right:2rem;">
                                    <span>Check Stream</span>
                                    <img src="http://www.gifstache.com/images/ajax_loader.gif" style="height:25px;margin-top:-0.45rem;margin-bottom:-0.45rem;" />
                                </a>
                            </div>
                        </div>
                        <button class="close-button" data-close aria-label="Close modal" type="button">
                            <i class="fi-x"></i>
                            <span class="show-for-sr">Close</span>
                        </button>
                    </div>
                    <button id="refresh" class="button" style="margin-bottom: 0; padding: 0.3rem 1rem; border-left: 1px solid white;">
                        <i class="fi-refresh" style="font-size: 1.7rem;"></i>
                        <span class="show-for-sr">Refresh</span>
                    </button>
                    <span id="lastRefresh" class="hide-for-small-only hide" style="margin-left: 0.5rem;">Last refresh: <span id="lastRefreshTime"></span></span>
                </div>
            </li>
        </ul>
    </div>
    <div class="top-bar-right">
        <ul class="menu">
            <li>
                <div class="input-group show-for-large" style="margin-bottom:0;">
                    <input type="text" id="usernameTopbar" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;" />
                    <div class="input-group-button">
                        <button id="usernameButtonTopbar" class="button" style="margin-bottom: 0; padding: 0.3rem 1rem;">
                            <i class="fi-save" style="font-size: 1.7rem;"></i>
                            <span class="show-for-sr">Save Username</span>
                        </button>
                    </div>
                </div>
                <button class="button hide-for-large" data-toggle="usernameDropdown" style="margin-bottom: 0; padding: 0.3rem 1rem;">
                    <i class="fi-torso" style="font-size: 1.7rem;"></i>
                    <span class="show-for-sr">Username Entry</span>
                </button>
                <div id="usernameDropdown" class="dropdown-pane hide-for-large" data-dropdown>
                    <div class="input-group" style="margin-bottom:0;">
                    <input type="text" id="username" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;width:100%;" />
                    <div class="input-group-button">
                        <button id="usernameButton" class="button" style="margin-bottom: 0; padding: 0.3rem 1rem;">
                            <i class="fi-save" style="font-size: 1.7rem;"></i>
                            <span class="show-for-sr">Save Username</span>
                        </button>
                    </div>
                </div>
                </div>
            </li>
        </ul>
    </div>
</nav>
<section id="currentStreams" class="row"></section>
<footer class="row">
    <div class="column">
        <hr />
        <p style="text-align:center;">&copy; <span id="year"></span> <a href="http://www.isaac-west.ca/">Isaac West</a></p>
    </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.js"></script>
<script>
    (function () {
        $(document).foundation();
        $("#year").text(new Date().getFullYear());
        $("#checkSingleStream img").hide();

        window.twitchStream = {
            currentUser: localStorage.getItem('twitchStream.currentUser'),
            quality: localStorage.getItem('twitchStream.quality'),
            autoRefresh: localStorage.getItem('twitchStream.autoRefresh'),
            twelveHour: localStorage.getItem('twitchStream.twelveHour'),

            refresh: function() {
                if (twitchStream.currentUser) {
                    twitchStream.getFollowed(twitchStream.currentUser);
                } else {
                    $("#currentStreams").empty();
                    $("#currentStreams").append(
                        $("<h5/>", {
                            text: "Enter a Username",
                            class: "text-center",
                            style: "font-style:italic;"
                        })
                    );
                    $("#lastRefresh").addClass("hide");
                }
            },

            getFollowed: function(username) {
                var url = "https://api.twitch.tv/kraken/users/" + username + "/follows/channels";
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        twitchStream.getStreams(result);
                    }
                });
            },

            getStreams: function(followedStreams) {
                if (followedStreams.follows.length > 0) {
                    var url = "https://api.twitch.tv/kraken/streams?channel=";

                    followedStreams.follows.forEach(function(item) {
                        url += item.channel.display_name + ",";
                    });

                    url = url.substring(0, url.length - 1);

                    $.ajax({
                        url: url,
                        cache: false,
                        success: function(result) {
                            twitchStream.renderStreams(result);
                        }
                    });
                }
            },

            renderStreams: function(currentStreams) {
                $("#currentStreams").empty();

                if (currentStreams.streams.length < 1) {
                    $("#currentStreams").append(
                        $("<h5/>", {
                            text: "No Channels Live",
                            class: "text-center",
                            style: "font-style:italic;"
                        })
                    );
                } else {
                    currentStreams.streams.sort(function(a, b) {
                        if (a.channel.display_name < b.channel.display_name) {
                            return -1;
                        }
                        if (a.channel.display_name > b.channel.display_name) {
                            return 1;
                        }
                        return 0;
                    });

                    currentStreams.streams.forEach(function(item) {
                        var $div = $("<div/>", {
                            class: "medium-4 small-12 columns"
                        });

                        var $panel = $("<div/>", {
                            class: "callout secondary",
                            style: "padding:0.75rem;"
                        }).appendTo($div);

                        $("<a/>", {
                            href: "http://www.twitch.tv/" + item.channel.display_name
                        }).append(
                            $("<img/>", {
                                src: item.preview.medium,
                                style: "margin-bottom:0.5rem;width:100%;height:100%;"
                            })
                        ).appendTo($panel);
                        
                        $("<h6/>", {
                            text: item.channel.status,
                            style: "white-space:nowrap;overflow:hidden;text-overflow: ellipsis;"
                        }).appendTo($panel);

                        $("<p/>", {
                            text: item.viewers + " watching ",
                            style: "text-align:right;white-space:nowrap;overflow:hidden;text-overflow: ellipsis;"
                        }).appendTo($panel).append(
                            $("<a/>", {
                                text: item.channel.display_name,
                                href: "http://www.twitch.tv/" + item.channel.display_name + "/profile"
                            })
                        );

                        var $buttonsRow = $("<div/>", {
                            class: "row collapse"
                        }).appendTo($panel);

                        $("<div/>", {
                            class: "small-3 columns"
                        }).appendTo($buttonsRow).append(
                            $("<a/>", {
                                onclick: "window.open('http://www.twitch.tv/" +
                                    item.channel.display_name +
                                    "/chat?popout=', 'newwindow', 'width=400, height=600');",
                                target: "_blank",
                                class: "button expanded secondary disabled",
                                style: "margin-bottom:0;padding:0.3rem 1rem;"
                            }).append(
                                $("<i/>", {
                                    class: "fi-comments",
                                    style: "color:#333;font-size:1.7rem;"
                                })
                            )
                        );

                        $("<div/>", {
                            class: "small-9 columns"
                        }).appendTo($buttonsRow).append(
                            $("<a/>", {
                                text: "Launch",
                                href: "livestreamer:" + item.channel.display_name + " " + twitchStream.quality,
                                class: "button expanded",
                                style: "margin-bottom:0;"
                            })
                        );

                        $("#currentStreams").append($div);
                    });

                    $("#currentStreams > div.columns:last-child").addClass("end");
                }

                twitchStream.updateRefreshTimestamp();
                $("#lastRefresh").removeClass("hide");
            },

            updateRefreshTimestamp: function() {
                var now = new Date();
                var hours = now.getHours();
                if (twitchStream.twelveHour) {
                    if (hours > 12) {
                        hours -= 12;
                    } else if (hours === 0) {
                        hours = 12;
                    }
                }
                var minutes = now.getMinutes();
                if (minutes < 10) {
                    minutes = "0" + minutes;
                }
                $("#lastRefreshTime").text(hours + ":" + minutes);
            },

            initAutoRefresh: function() {
                clearInterval();
                if (twitchStream.autoRefresh) {
                    setInterval(function() {
                            twitchStream.refresh();
                        }, 1000 * 60 * 2
                    );
                }
            },

            singleStream: {
                checkStream: function(channelName) {
                    $("#checkSingleStream span").hide();
                    $("#checkSingleStream img").show();
                    $.ajax({
                        url: "https://api.twitch.tv/kraken/streams?channel=" + channelName,
                        cache: false,
                        success: function(result) {
                            twitchStream.singleStream.updateButton(channelName, result);
                        },
                        error: function() {
                            $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Error").show();
                            $("#checkSingleStream img").hide();
                        }
                    });                    
                },

                updateButton: function(channelName, stream) {
                    if (stream.streams.length > 0) {
                        $("#checkSingleStream")
                            .removeClass("primary")
                            .addClass("success")
                            .prop("href", "livestreamer:" + channelName + " " + twitchStream.quality);
                        $("#checkSingleStream span").text("Launch Stream").show();
                        $("#checkSingleStream img").hide();
                    } else {
                        $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Not Live").show();
                            $("#checkSingleStream img").hide();
                    }
                }
            }
        };

        if (twitchStream.currentUser) {
            $("#username").val(twitchStream.currentUser);
            $("#usernameTopbar").val(twitchStream.currentUser);
        }

        if (twitchStream.quality) {
            $("#quality").val(twitchStream.quality);
        } else {
            $("#quality").val("best");
            localStorage.setItem('twitchStream.quality', "best");
            twitchStream.quality = "best";
        }

        if (twitchStream.autoRefresh) {
            $("#autoRefresh").prop("checked", true);
            twitchStream.initAutoRefresh();
        }

        if (twitchStream.twelveHour) {
            $("#twelveHour").prop("checked", true);
        }

        $("#usernameButton, #usernameButtonTopbar").on("click", function() {
            var username = $("#username").val();
            localStorage.setItem('twitchStream.currentUser', username);
            twitchStream.currentUser = username;
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#username").on("keyup", function() {
            $("#usernameTopbar").val($(this).val());
        });

        $("#usernameTopbar").on("keyup", function() {
            $("#username").val($(this).val());
        });

        $("#quality").on("change", function() {
            var quality = $(this).val();
            localStorage.setItem('twitchStream.quality', quality);
            twitchStream.quality = quality;
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#autoRefresh").on("change", function() {
            var autoRefresh = $(this).is(":checked");
            if (autoRefresh) {
                localStorage.setItem("twitchStream.autoRefresh", autoRefresh);
            } else {
                localStorage.removeItem("twitchStream.autoRefresh");
            }
            twitchStream.autoRefresh = autoRefresh;
            if (autoRefresh) {
                twitchStream.initAutoRefresh();
                twitchStream.refresh();
            } else {
                clearInterval();
            }
        });

        $("#twelveHour").on("change", function() {
            var twelveHour = $(this).is(":checked");
            if (twelveHour) {
                localStorage.setItem("twitchStream.twelveHour", twelveHour);
            } else {
                localStorage.removeItem("twitchStream.twelveHour");
            }
            twitchStream.twelveHour = twelveHour;
            if (!$("#lastRefresh").hasClass("hide")) {
                twitchStream.updateRefreshTimestamp();
            }
        });

        $("#channelName").on("keyup", function() {
            $("#checkSingleStream")
                .removeClass("success")
                .removeClass("alert")
                .addClass("primary")
                .removeAttr("href");
            $("#checkSingleStream span").text("Check Stream").show();
            $("#checkSingleStream img").hide();

            if ($(this).val() === "") {
                $("#checkSingleStream").addClass("disabled");
            } else {
                $("#checkSingleStream").removeClass("disabled");
            }
        });

        $("#checkSingleStream").on("click", function() {
            var $button = $("#checkSingleStream");
            if ($button.hasClass("primary") || $button.hasClass("alert")) {
                twitchStream.singleStream.checkStream($("#channelName").val());
            }
        });

        $("#refresh").on("click", function() {
            twitchStream.initAutoRefresh();
            twitchStream.refresh();
        });

        twitchStream.refresh();
    })();
</script>
</body>
<!--
    Prerequisites
        VLC             http://www.videolan.org/vlc/index.html
        Livestreamer    http://docs.livestreamer.io/

    launch.bat
        set "str=%1
        set "var2=%str:*:=%"
        livestreamer twitch.tv/%var2%

    Protocol Setup      https://msdn.microsoft.com/en-us/library/aa767914%28v=vs.85%29.aspx

        1. In regedit, find HKEY_CLASSES_ROOT
        2. Add a key named "livestreamer" 
        3. Set livestreamer's default string to "URL:Livestreamer Protocol"
        4. Add an empty string to livestreamer called "URL Protocol"
        5. Add a key to livestreamer named "shell"
        6. Add a key to shell named "open"
        7. Add a key to open named "command"
        8. Set command's default string to the path of launch.bat (see below)

        HKEY_CLASSES_ROOT
            livestreamer
                (Default) = "URL:Livestreamer Protocol"
                URL Protocol = ""
                shell
                    open
                        command
                            (Default) = "C:\...\launch.bat" "%1"
-->
</html>
