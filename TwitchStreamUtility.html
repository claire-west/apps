<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twitch Stream Utility</title>
    <link rel="icon" href="http://www.twitch.tv/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/foundation-icons/3.0/foundation-icons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/fontawesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" />
    <style>
        .truncate-line-wrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .topbar-button-fa,
        .topbar-button-fi {
            height: 40px;
            width: 56px;
            padding: 0;
            margin-bottom: 0;
            border-left: 1px solid white;
        }
        .topbar-button-fa {
            padding-top: 7px;
            padding-bottom: 7px;
        }
        .topbar-button-fi {
            padding-top: 3px;
            padding-bottom: 3px;
        }
        .topbar-button-fa i {
            font-size: 23px;
        }
        .topbar-button-fi i {
            font-size: 30px;
        }

        #playlists h4,
        #playlists h6 {
            margin-bottom: 0;
        }
        #playlists h6 strong {
            line-height: 35px;
        }
        #playlists div.playlist-row {
            padding-top: 4px;
            padding-bottom: 4px;
        }
        #playlists div.playlist-row {
            background: #F9F9F9;
            margin-bottom: 1px
        }
        #playlists i.fa-edit {
            margin-top: 2px;
        }
        #playlists span {
            line-height: 40px;
        }
        #playlists div.switch {
            margin-bottom: 0;
        }
        #playlists label.switch-paddle {
            margin-top: 4px;
        }
        #playlists div.button-group {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
<nav class="top-bar" style="margin-bottom:0.5rem;">
    <div class="top-bar-left">
        <ul class="menu">
            <li class="menu-text hide-for-small-only">Twitch Stream Utility</li>
            <li>
                <div class="input-group" style="margin-bottom: 0;">
                    <button class="topbar-button-fa button secondary" data-toggle="securityDropdown" style="border-left:none;">
                        <i class="fa fa-shield"></i>
                        <span class="show-for-sr">Security Warning</span>
                    </button>
                    <div class="dropdown-pane" id="securityDropdown" data-dropdown>
                        <p style="margin-bottom:0;"><strong>Security Notice:</strong>&nbsp;This tool involves running a batch file located on your computer. When you click a link using the custom protocol it will run this script.</p>
                        <p>While unlikely, if you click a link elsewhere that uses a protocol with the same name it is possible someone could take advantage of this. Use at your own risk.</p>
                    </div>
                    <button class="topbar-button-fa button secondary" data-open="setupReveal">
                        <i class="fa fa-info-circle"></i>
                        <span class="show-for-sr">Setup Instructions</span>
                    </button>
                    <div id="setupReveal" class="reveal" data-reveal>
                        <h5>Setup</h5>
                        <h6><strong>Prerequisites</strong></h6>
                        <ul style="background-color:white;">
                            <li><a href="http://www.videolan.org/vlc/index.html">VLC</a></li>
                            <li><a href="http://docs.livestreamer.io/">Livestreamer</a></li>
                        </ul>
                        <h6 style="margin-top:0.5rem;"><strong>launch.bat</strong></h6>
                        <code>set "str=%1</code><br />
                        <code>set "var2=%str:*:=%"</code><br />
                        <code>livestreamer twitch.tv/%var2%</code><br />
                        <h6 style="margin-top:0.5rem;"><strong>Protocol Setup</strong></h6>
                        <ol>
                            <li>In regedit, find HKEY_CLASSES_ROOT</li>
                            <li>Add a key named "livestreamer"</li>
                            <li>Set livestreamer's default string to "URL:Livestreamer Protocol"</li>
                            <li>Add an empty string to livestreamer called "URL Protocol"</li>
                            <li>Add a key to livestreamer named "shell"</li>
                            <li>Add a key to shell named "open"</li>
                            <li>Add a key to open named "command"</li>
                            <li>Set command's default string to the path of launch.bat (see below)</li>
                        </ol>
                        <p style="margin-top:0.5rem;margin-bottom:0.5rem;">The final structure should look like this:</p>
                        <p style="margin-bottom:0;">HKEY_CLASSES_ROOT</p>
                        <p style="margin-bottom:0;text-indent:1rem;">livestreamer</p>
                        <p style="margin-bottom:0;text-indent:2rem;">(Default) = "URL:Livestreamer Protocol"</p>
                        <p style="margin-bottom:0;text-indent:2rem;">URL Protocol = ""</p>
                        <p style="margin-bottom:0;text-indent:2rem;">shell</p>
                        <p style="margin-bottom:0;text-indent:3rem;">open</p>
                        <p style="margin-bottom:0;text-indent:4rem;">command</p>
                        <p style="margin-bottom:0;text-indent:5rem;">(Default) = "C:\...\launch.bat" "%1"</p>
                        <button class="close-button" data-close aria-label="Close modal" type="button">
                            <i class="fi-x"></i>
                            <span class="show-for-sr">Close</span>
                        </button>
                    </div>
                    <button class="topbar-button-fa button secondary" data-toggle="settingsDropdown">
                        <i class="fa fa-cog"></i>
                        <span class="show-for-sr">Settings</span>
                    </button>
                    <div class="dropdown-pane" id="settingsDropdown" data-dropdown>
                        <div class="input-group">
                            <label for="quality" class="input-group-label">Quality</label>
                            <select id="quality" class="input-group-field">
                                <option value="best">Best</option>
                                <option value="source">Source</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                                <option value="mobile">Mobile</option>
                                <option value="audio">Audio</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="autoRefresh" class="input-group-label" style="width: 226px;">Refresh every 2 minutes</label>
                            <input type="checkbox" id="autoRefresh" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label for="twelveHour" class="input-group-label" style="width: 226px;">12-hour time</label>
                            <input type="checkbox" id="twelveHour" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
                        </div>
                    </div>
                    <button class="topbar-button-fi button" data-toggle="singleEntryDropdown">
                        <i class="fi-play-video"></i>
                        <span class="show-for-sr">Specify a Stream</span>
                    </button>
                    <div id="singleEntryDropdown" class="dropdown-pane" data-dropdown style="width:30rem;">
                        <div class="input-group" style="margin-bottom:0.5rem;">
                            <label for="channelName" class="input-group-label" style="width:6rem;">Channel</label>
                            <input type="text"id="channelName" class="input-group-field" placeholder="Channel Name" style="text-align:center;width:100%;" />
                            <div class="input-group-button">
                                <a id="checkSingleStream" class="button primary disabled" style="width:8.1rem;">
                                    <span>Check Stream</span>
                                    <img src="http://www.gifstache.com/images/ajax_loader.gif" style="height:25px;margin-top:-0.45rem;margin-bottom:-0.45rem;" />
                                </a>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label for="gameTitle" class="input-group-label" style="width:6rem;">Game</label>
                            <input type="text" id="gameTitle" class="input-group-field" placeholder="Game Title" style="text-align:center;width:100%;" />
                            <div class="input-group-button">
                                <a id="checkGame" class="button primary disabled" style="width:8.1rem;">
                                    <span>Check Game</span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <button id="playlistToggle" class="topbar-button-fa button">
                        <i class="fa fa-th" style="margin-top: 2px;"></i>
                        <span class="show-for-sr">Manage Playlists</span>
                    </button>
                    <button id="refresh" class="topbar-button-fa button">
                        <i class="fa fa-refresh"></i>
                        <span class="show-for-sr">Refresh</span>
                    </button>
                    <span id="lastRefresh" class="hide-for-small-only hide" style="margin-left: 0.5rem;">Last refresh: <span id="lastRefreshTime"></span></span>
                </div>
            </li>
        </ul>
    </div>
    <div class="top-bar-right">
        <ul class="menu">
            <li>
                <div class="input-group show-for-large" style="margin-bottom:0;">
                    <input type="text" id="usernameTopbar" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;" />
                    <div class="input-group-button">
                        <button id="usernameButtonTopbar" class="topbar-button-fa button" style="border-left:none;">
                            <i class="fa fa-save"></i>
                            <span class="show-for-sr">Save Username</span>
                        </button>
                    </div>
                </div>
                <button class="topbar-button-fi button hide-for-large" data-toggle="usernameDropdown" style="border-left:none;">
                    <i class="fi-torso"></i>
                    <span class="show-for-sr">Username Entry</span>
                </button>
                <div id="usernameDropdown" class="dropdown-pane hide-for-large" data-dropdown>
                    <div class="input-group" style="margin-bottom:0;">
                        <input type="text" id="username" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;width:100%;" />
                        <div class="input-group-button">
                            <button id="usernameButton" class="topbar-button-fa button" style="border-left:none;">
                                <i class="fa fa-save"></i>
                                <span class="show-for-sr">Save Username</span>
                            </button>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>
<section id="currentStreams" class="row"></section>
<section id="playlists">
    <div class="row">
        <div class="small-2 columns"><h4>Playlists</h4></div>
        <div class="small-2 columns">
            <h6><strong>Type</strong></h6>
        </div>
        <div class="small-6 columns">
            <h6><strong>Name</strong></h6>
        </div>
        <div class="small-2 columns">
            <h6 class="text-center"><strong>Active</strong></h6>
        </div>
    </div>
    <div id="playlistsTemporary" class="row playlist-row">
        <div class="small-2 columns">
            <div class="button-group">
                <button class="button hollow secondary disabled topbar-button-fa">
                    <i class="fa fa-trash-o"></i>
                    <span class="show-for-sr">Delete Playlist</span>
                </button>
                <button class="button hollow disabled topbar-button-fa">
                    <i class="fa fa-edit"></i>
                    <span class="show-for-sr">Edit Playlist</span>
                </button>
            </div>
        </div>
        <div class="small-2 columns"><span>Temporary</span></div>
        <div class="small-6 columns"><span id="temporaryPlaylistName"></span></div>
        <div class="small-2 columns">
            <div class="switch text-center">
                <input type="radio" id="temporarySwitch" class="switch-input" name="activePlaylist" value="temporary" />
                <label class="switch-paddle" for="temporarySwitch" style="opacity:0.25;cursor:not-allowed;pointer-events:none;">
                    <span class="show-for-sr">Temporary Playlist</span>
                </label>
            </div>
        </div>
    </div>
    <div class="row playlist-row">
        <div class="small-2 columns">
            <div class="button-group">
                <button class="button hollow secondary disabled topbar-button-fa">
                    <i class="fa fa-trash-o"></i>
                    <span class="show-for-sr">Delete Playlist</span>
                </button>
                <button class="button hollow disabled topbar-button-fa">
                    <i class="fa fa-edit"></i>
                    <span class="show-for-sr">Edit Playlist</span>
                </button>
            </div>
        </div>
        <div class="small-2 columns"><span style="font-style:italic;">(default)</span></div>
        <div class="small-6 columns"><span>Followed Channels</span></div>
        <div class="small-2 columns">
            <div class="switch text-center">
                <input type="radio" id="followedSwitch" class="switch-input" name="activePlaylist" value="followed" />
                <label class="switch-paddle" for="followedSwitch">
                    <span class="show-for-sr">Followed Channels</span>
                </label>
            </div>
        </div>
    </div>
    <div class="row playlist-row">
        <div class="small-2 columns">
            <div class="button-group">
                <button class="button hollow secondary disabled topbar-button-fa">
                    <i class="fa fa-trash-o"></i>
                    <span class="show-for-sr">Delete Playlist</span>
                </button>
                <button class="button hollow disabled topbar-button-fa">
                    <i class="fa fa-edit"></i>
                    <span class="show-for-sr">Edit Playlist</span>
                </button>
            </div>
        </div>
        <div class="small-2 columns"><span style="font-style:italic;">(default)</span></div>
        <div class="small-6 columns"><span>Live Hosts</span></div>
        <div class="small-2 columns">
            <div class="switch text-center">
                <input type="radio" id="hostsSwitch" class="switch-input" name="activePlaylist" value="hosts" />
                <label class="switch-paddle" for="hostsSwitch">
                    <span class="show-for-sr">Live Hosts</span>
                </label>
            </div>
        </div>
    </div>
    <section id="playlistsGames"></section>
    <section id="playlistsCustom"></section>
</section>
<footer class="row">
    <div class="column">
        <hr />
        <p style="text-align:center;">&copy; <span id="year"></span> <a href="http://www.isaac-west.ca/">Isaac West</a></p>
    </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.js"></script>
<script>
    (function () {
        $(document).foundation();
        $("#playlists").hide();
        $("#playlistsTemporary").hide();
        $("#singleEntryDropdown img").hide();
        $("#year").text(new Date().getFullYear());
        
        window.twitchStream = {
            currentUser: localStorage.getItem("twitchStream.currentUser"),
            quality: localStorage.getItem("twitchStream.quality"),
            autoRefresh: localStorage.getItem("twitchStream.autoRefresh"),
            twelveHour: localStorage.getItem("twitchStream.twelveHour"),
            activePlaylist: localStorage.getItem("twitchStream.activePlaylist"),

            refresh: function() {
                if (twitchStream.activePlaylist === "game") {
                    twitchStream.getGames(twitchStream.playlistData.title);
                } else if (twitchStream.activePlaylist === "custom") {
                    //TODO
                } else if (twitchStream.currentUser) {
                    $("#refresh i").addClass("fa-spin");
                    if (twitchStream.activePlaylist === "followed") {
                        twitchStream.getFollowed(twitchStream.currentUser);
                    } else if (twitchStream.activePlaylist === "hosts") {
                        twitchStream.getHosts(twitchStream.currentUser);
                    }
                } else {
                    $("#currentStreams").empty();
                    $("#currentStreams").append(
                        $("<h5/>", {
                            text: "Enter a Username",
                            class: "text-center",
                            style: "font-style:italic;"
                        })
                    );
                    $("#lastRefresh").addClass("hide");
                }
            },

            useTemporaryPlaylist: function() {
                $("#refresh i").addClass("fa-spin");
                $("#singleEntryDropdown").foundation("close");
                twitchStream.activePlaylist = twitchStream.temporaryPlaylist.type
                twitchStream.playlistData = twitchStream.temporaryPlaylist.data
                twitchStream.refresh();
                if (twitchStream.activePlaylist === "game") {
                    $("#temporaryPlaylistName").text("Game: " + twitchStream.playlistData.title);
                }
                $("#temporarySwitch").prop("checked", true)
                $("#playlistsTemporary").show();
            },

            getFollowed: function(username) {
                var url = "https://api.twitch.tv/kraken/users/" + username + "/follows/channels";
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        twitchStream.getStreams(result);
                    },
                    error: function() {
                        $("#refresh i").removeClass("fa-spin");
                    }
                });
            },

            getStreams: function(followedStreams) {
                $("#currentStreams").empty();
                if (followedStreams.follows.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Followed Channels"));
                } else {
                    var url = "https://api.twitch.tv/kraken/streams?channel=";

                    followedStreams.follows.forEach(function(item) {
                        url += item.channel.display_name + ",";
                    });

                    url = url.substring(0, url.length - 1);

                    $.ajax({
                        url: url,
                        cache: false,
                        success: function(result) {
                            result.streams.sort(function(a, b) {
                                if (a.channel.display_name < b.channel.display_name) {
                                    return -1;
                                }
                                if (a.channel.display_name > b.channel.display_name) {
                                    return 1;
                                }
                                return 0;
                            });
                            twitchStream.renderStreams(result.streams, "Followed Streams");
                        }
                    });
                }
            },

            renderStreams: function(streams, title) {
                if (streams.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Channels Live"));
                } else {
                    $("#currentStreams").append(twitchStream.rendering.title(title));

                    var now = Date.now();
                    streams.forEach(function(item) {
                        $("#currentStreams").append(
                            twitchStream.rendering.renderFollow(
                                item.channel.display_name,
                                item.channel.status,
                                item.preview.medium,
                                item.viewers,
                                now
                            )
                        );
                    });

                    $("#currentStreams > div.columns:last-child").addClass("end");
                }

                twitchStream.updateRefreshTimestamp();
                $("#lastRefresh").removeClass("hide");
                $("#refresh i").removeClass("fa-spin");
            },

            getHosts: function(username) {
                $("#currentStreams").empty();
                var url = "http://api.twitch.tv/api/users/" + username + "/followed/hosting?callback=?";
                $.getJSON(url, function(data) {
                    twitchStream.renderHosts(data.hosts);
                });
            },

            renderHosts: function(hosts) {
                if (hosts.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Live Hosts"));
                } else {
                    hosts.sort(function(a, b) {
                        return a.target.viewers - b.target.viewers;
                    });

                    $("#currentStreams").append(twitchStream.rendering.title("Live Hosts"));

                    var now = Date.now();
                    hosts.forEach(function(item) {
                        $("#currentStreams").append(
                            twitchStream.rendering.renderHost(
                                item.display_name,
                                item.target.channel.name,
                                item.target.preview,
                                item.target.viewers,
                                now
                            )
                        );
                    });

                    $("#currentStreams > div.columns:last-child").addClass("end");
                }

                twitchStream.updateRefreshTimestamp();
                $("#lastRefresh").removeClass("hide");
                $("#refresh i").removeClass("fa-spin");
            },

            getGames: function(fragment) {
                var url = "https://api.twitch.tv/kraken/search/games?q=" + fragment + "&type=suggest&live=true";
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        twitchStream.getGameTitle(result);
                    }
                });
            },

            getGameTitle: function(result) {
                $("#currentStreams").empty();
                if (result.games.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Games Found"));
                } else {
                    twitchStream.getGameStreams(result.games[0].name);
                }
            },

            getGameStreams: function(title) {
                var url = "https://api.twitch.tv/kraken/streams?game=" + title;
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        result.streams.sort(function(a, b) {
                            return b.viewers - a.viewers;
                        });
                        twitchStream.renderStreams(result.streams, title);
                    }
                });
            },

            updateRefreshTimestamp: function() {
                var now = new Date();
                var hours = now.getHours();
                if (twitchStream.twelveHour) {
                    if (hours > 12) {
                        hours -= 12;
                    } else if (hours === 0) {
                        hours = 12;
                    }
                }
                var minutes = now.getMinutes();
                if (minutes < 10) {
                    minutes = "0" + minutes;
                }
                $("#lastRefreshTime").text(hours + ":" + minutes);
            },

            initAutoRefresh: function() {
                if (twitchStream.autoRefreshInterval) {
                    clearInterval(twitchStream.autoRefreshInterval);
                }
                if (twitchStream.autoRefresh) {
                    twitchStream.autoRefreshInterval = setInterval(function() {
                            twitchStream.refresh();
                        }, 1000 * 60 * 2
                    );
                }
            },

            setValue: function(key, value) {
                localStorage.setItem("twitchStream." + key, value);
                twitchStream[key] = value;
            },

            getValue: function(key) {
                if (!twitchStream[key]) {
                    twitchStream[key] = localStorage.getItem("twitchStream." + key);
                }
                return twitchStream[key];
            },

            clearValue: function(key) {
                localStorage.removeItem("twitchStream." + key);
                delete twitchStream[key];
            },

            rendering: {
                title: function(title) {
                    return $("<div/>", {
                        class: "column"
                    }).append(
                        $("<h4/>", {
                            text: title
                        })
                    )
                },

                error: function(error) {
                    $("#refresh i").removeClass("fa-spin");
                    return $("<div/>", {
                        class: "column"
                    }).append(
                        $("<h5/>", {
                            text: error,
                            class: "text-center",
                            style: "font-style:italic;margin-top:0.4375rem;"
                        })
                    )
                },

                playlistRow: function(type, name, key) {
                    $div = $("<div/>", {
                        class: "row playlist-row"
                    });

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<div/>", {
                            class: "button-group"
                        }).append(
                            $("<button/>", {
                                class: "button hollow secondary topbar-button-fa"
                            }).append(
                                $("<i/>", {
                                    class: "fa fa-trash-o"
                                })
                            ).append(
                                $("<span/>", {
                                    text: "Delete Playlist",
                                    class: "show-for-sr"
                                })
                            )
                        ).append(
                            $("<button/>", {
                                class: "button hollow topbar-button-fa"
                            }).append(
                                $("<i/>", {
                                    class: "fa fa-edit"
                                })
                            ).append(
                                $("<span/>", {
                                    text: "Edit Playlist",
                                    class: "show-for-sr"
                                })
                            )
                        )
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<span/>", {
                            text: type
                        })
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-6 columns"
                    }).append(
                        $("<span/>", {
                            text: name
                        })
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<div/>", {
                            class: "switch text-center"
                        }).append(
                            $("<input/>", {
                                type: "radio",
                                id: key + "Switch",
                                class: "switch-input",
                                name: "activePlaylist",
                                value: key
                            })
                        ).append(
                            $("<label/>", {
                                class: "switch-paddle",
                                for: key + "Switch"
                            }).append(
                                $("<span/>", {
                                    text: name,
                                    class: "show-for-sr"
                                })
                            )
                        )
                    ).appendTo($div);

                    return $div;
                },

                outerDiv: function() {
                    return $("<div/>", {
                        class: "medium-4 small-12 columns"
                    });
                },

                panel: function() {
                    return $("<div/>", {
                        class: "callout secondary",
                        style: "padding:0.75rem;"
                    });
                },

                preview: function(channelName, src, now) {
                    return $("<a/>", {
                        href: "http://www.twitch.tv/" + channelName
                    }).append(
                        $("<img/>", {
                            src: src + "?" + now,
                            style: "margin-bottom:0.5rem;width:100%;height:100%;"
                        })
                    )
                },

                status: function(status) {
                    return $("<h6/>", {
                        text: status,
                        class: "truncate-line-wrap",
                        style: "margin-bottom:0;"
                    })
                },

                viewers: function(viewers) {
                    return $("<p/>", {
                        text: viewers + " watching ",
                        class: "truncate-line-wrap",
                        style: "margin-bottom:0.5rem;text-align:right;"
                    })
                },

                profileLink: function(channelName) {
                    return $("<a/>", {
                        text: channelName,
                        href: "http://www.twitch.tv/" + channelName + "/profile"
                    })
                },

                buttonsRow: function(channelName) {
                    var $buttonsRow = $("<div/>", {
                        class: "row collapse"
                    })

                    $("<div/>", {
                        class: "small-3 columns"
                    }).appendTo($buttonsRow).append(
                        $("<a/>", {
                            href: "http://www.twitch.tv/" + channelName + "/chat",
                            target: "_blank",
                            class: "button hollow expanded secondary disabled",
                            style: "margin-bottom:0;padding:0.3rem 1rem;"
                        }).append(
                            $("<i/>", {
                                class: "fi-comments",
                                style: "color:#333;font-size:1.7rem;"
                            })
                        )
                    );

                    $("<div/>", {
                        class: "small-9 columns"
                    }).appendTo($buttonsRow).append(
                        $("<a/>", {
                            text: "Launch",
                            href: "livestreamer:" + channelName + " " + twitchStream.quality,
                            class: "button expanded",
                            style: "margin-bottom:0;"
                        })
                    );

                    return $buttonsRow;
                },

                renderFollow: function(channelName, status, preview, viewers, now) {
                    var $div = twitchStream.rendering.outerDiv();
                    var $panel = twitchStream.rendering.panel().appendTo($div);

                    twitchStream.rendering.preview(
                        channelName,
                        preview,
                        now
                    ).appendTo($panel);
                    
                    twitchStream.rendering.status(
                        status
                    ).appendTo($panel);

                    twitchStream.rendering.viewers(
                        viewers
                    ).appendTo($panel)
                        .append(twitchStream.rendering.profileLink(channelName)
                    );

                    twitchStream.rendering.buttonsRow(
                        channelName
                    ).appendTo($panel);

                    return $div;
                },

                renderHost: function(hostName, targetName, preview, viewers, now) {
                    var $div = twitchStream.rendering.outerDiv();
                    var $panel = twitchStream.rendering.panel().appendTo($div);

                    twitchStream.rendering.preview(
                        targetName,
                        preview,
                        now
                    ).appendTo($panel);
                    
                    twitchStream.rendering.status(
                        hostName + " hosting " + targetName
                    ).appendTo($panel);

                    twitchStream.rendering.viewers(
                        viewers
                    ).appendTo($panel)
                        .append(twitchStream.rendering.profileLink(targetName)
                    );

                    twitchStream.rendering.buttonsRow(
                        targetName
                    ).appendTo($panel);

                    return $div;
                }
            },

            singleStream: {
                checkStream: function(channelName) {
                    $("#checkSingleStream span").hide();
                    $("#checkSingleStream img").show();
                    $.ajax({
                        url: "https://api.twitch.tv/kraken/streams?channel=" + channelName,
                        cache: false,
                        success: function(result) {
                            twitchStream.singleStream.updateButton(channelName, result);
                        },
                        error: function() {
                            $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Error").show();
                            $("#checkSingleStream img").hide();
                        }
                    });                    
                },

                updateButton: function(channelName, stream) {
                    if (stream.streams.length > 0) {
                        $("#checkSingleStream")
                            .removeClass("primary")
                            .addClass("success")
                            .prop("href", "livestreamer:" + channelName + " " + twitchStream.quality);
                        $("#checkSingleStream span").text("Launch Stream").show();
                        $("#checkSingleStream img").hide();
                        if (twitchStream.singleStream.timeout) {
                            clearTimeout(twitchStream.singleStream.timeout);
                        }
                        twitchStream.singleStream.timeout = setTimeout(function() {
                                $button = $("#checkSingleStream");
                                if ($button.hasClass("success")) {
                                    $button.removeClass("success")
                                        .addClass("primary")
                                        .removeAttr("href")
                                    $("#checkSingleStream span").text("Check Stream");
                                }
                            },
                            1000 * 30
                        );
                    } else {
                        $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Not Live").show();
                            $("#checkSingleStream img").hide();
                    }
                }
            }
        };

        if (twitchStream.currentUser) {
            $("#username").val(twitchStream.currentUser);
            $("#usernameTopbar").val(twitchStream.currentUser);
        }

        if (twitchStream.quality) {
            $("#quality").val(twitchStream.quality);
        } else {
            $("#quality").val("best");
            twitchStream.setValue("quality", "best");
        }

        if (twitchStream.autoRefresh) {
            $("#autoRefresh").prop("checked", true);
            twitchStream.initAutoRefresh();
        }

        if (twitchStream.twelveHour) {
            $("#twelveHour").prop("checked", true);
        }

        if (twitchStream.activePlaylist) {
            $("input[name=activePlaylist][value=" + twitchStream.activePlaylist + "]").attr('checked', 'checked');
        } else {
            $("input[name=activePlaylist][value=followed]").attr('checked', 'checked');
            twitchStream.setValue("activePlaylist", "followed");
        }

        $("#usernameButton").on("click", function() {
            $("#usernameDropdown").foundation("close");
        });

        $("#usernameButton, #usernameButtonTopbar").on("click", function() {
            var username = $("#username").val();
            twitchStream.setValue("currentUser", username);
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#username").on("keyup", function() {
            $("#usernameTopbar").val($(this).val());
        });

        $("#usernameTopbar").on("keyup", function() {
            $("#username").val($(this).val());
        });

        $("#quality").on("change", function() {
            var quality = $(this).val();
            twitchStream.setValue("quality", quality);
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#autoRefresh").on("change", function() {
            var autoRefresh = $(this).is(":checked");
            if (autoRefresh) {
                localStorage.setItem("twitchStream.autoRefresh", autoRefresh);
            } else {
                localStorage.removeItem("twitchStream.autoRefresh");
            }
            twitchStream.autoRefresh = autoRefresh;
            if (autoRefresh) {
                twitchStream.initAutoRefresh();
                twitchStream.refresh();
            } else {
                clearInterval(twitchStream.autoRefreshInterval);
            }
        });

        $("#twelveHour").on("change", function() {
            var twelveHour = $(this).is(":checked");
            if (twelveHour) {
                localStorage.setItem("twitchStream.twelveHour", twelveHour);
            } else {
                localStorage.removeItem("twitchStream.twelveHour");
            }
            twitchStream.twelveHour = twelveHour;
            if (!$("#lastRefresh").hasClass("hide")) {
                twitchStream.updateRefreshTimestamp();
            }
        });

        $("#channelName").on("keyup", function() {
            $("#checkSingleStream")
                .removeClass("success")
                .removeClass("alert")
                .addClass("primary")
                .removeAttr("href");
            $("#checkSingleStream span").text("Check Stream").show();
            $("#checkSingleStream img").hide();

            if ($(this).val() === "") {
                $("#checkSingleStream").addClass("disabled");
            } else {
                $("#checkSingleStream").removeClass("disabled");
            }
        });

        $("#checkSingleStream").on("click", function() {
            var $button = $("#checkSingleStream");
            if ($button.hasClass("primary") || $button.hasClass("alert")) {
                twitchStream.singleStream.checkStream($("#channelName").val());
            }
        });

        $("#gameTitle").on("keyup", function() {
            if ($(this).val() === "") {
                $("#checkGame").addClass("disabled");
            } else {
                $("#checkGame").removeClass("disabled");
            }
        });

        $("#checkGame").on("click", function() {
            twitchStream.temporaryPlaylist = {
                type: "game",
                data: {
                    title: $("#gameTitle").val()
                }
            };
            $("#playlists").hide();
            $("#currentStreams").show();
            twitchStream.useTemporaryPlaylist();
        });

        $("input[name=activePlaylist]").on("change", function() {
            var activePlaylist = $(this).val();
            if (activePlaylist !== "temporary") {
                $("#playlistsTemporary").hide();
            }
            twitchStream.setValue("activePlaylist", activePlaylist);
            $("#currentStreams").empty();
            $("#playlists").hide();
            $("#currentStreams").show();
            twitchStream.refresh();
        });

        $("#temporarySwitch").off("click");
        $("#temporarySwitch").on("click", function(event) {
            event.preventDefault();
        });

        $("#playlistToggle").on("click", function() {
            $("#currentStreams").toggle();
            $("#playlists").toggle();
        });

        $("#refresh").on("click", function() {
            twitchStream.initAutoRefresh();
            twitchStream.refresh();
        });

        twitchStream.refresh();
    })();
</script>
</body>
<!--
    Prerequisites
        VLC             http://www.videolan.org/vlc/index.html
        Livestreamer    http://docs.livestreamer.io/

    launch.bat
        set "str=%1
        set "var2=%str:*:=%"
        livestreamer twitch.tv/%var2%

    Protocol Setup      https://msdn.microsoft.com/en-us/library/aa767914%28v=vs.85%29.aspx

        1. In regedit, find HKEY_CLASSES_ROOT
        2. Add a key named "livestreamer" 
        3. Set livestreamer's default string to "URL:Livestreamer Protocol"
        4. Add an empty string to livestreamer called "URL Protocol"
        5. Add a key to livestreamer named "shell"
        6. Add a key to shell named "open"
        7. Add a key to open named "command"
        8. Set command's default string to the path of launch.bat (see below)

        HKEY_CLASSES_ROOT
            livestreamer
                (Default) = "URL:Livestreamer Protocol"
                URL Protocol = ""
                shell
                    open
                        command
                            (Default) = "C:\...\launch.bat" "%1"
-->
</html>
