<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twitch Stream Utility</title>
    <link rel="icon" href="http://www.twitch.tv/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/foundation-icons/3.0/foundation-icons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/fontawesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" />
    <style>
        .truncate-line-wrap {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .topbar-button-fa,
        .topbar-button-fi {
            height: 40px;
            width: 56px;
            padding: 0;
            margin-bottom: 0;
            border-left: 1px solid white;
        }
        .topbar-button-fa {
            padding-top: 7px;
            padding-bottom: 7px;
        }
        .topbar-button-fi {
            padding-top: 3px;
            padding-bottom: 3px;
        }
        .topbar-button-fa i {
            font-size: 23px;
        }
        .topbar-button-fi i {
            font-size: 30px;
        }

        #playlists h4,
        #playlists h6 {
            margin-bottom: 0;
        }
        #playlists h6 strong {
            line-height: 35px;
        }
        #playlists div.playlist-row,
        #gamePlaylistResults div.playlist-row {
            background: #F9F9F9;
            margin-bottom: 1px;
            padding-top: 4px;
            padding-bottom: 4px;
        }
        #playlists i.fa-edit {
            margin-top: 2px;
        }
        #playlists span {
            line-height: 40px;
        }
        #playlists div.switch {
            margin-bottom: 0;
        }
        #playlists label.switch-paddle {
            margin-top: 4px;
        }
        #playlists div.button-group {
            margin-bottom: 0;
        }

        #newPlaylist ul.tabs li.tabs-title a {
            font-size: 1rem;
            padding: 0.8rem;
        }
    </style>
</head>
<body style="overflow-x:hidden;">
<nav class="top-bar" style="margin-bottom:0.5rem;">
    <div class="top-bar-left">
        <ul class="menu">
            <li class="menu-text hide-for-small-only">Twitch Stream Utility</li>
            <li>
                <div class="input-group" style="margin-bottom: 0;">
                    <button class="topbar-button-fa button secondary" title="Setup" data-section="setup" style="border-left:none;">
                        <i class="fa fa-info-circle"></i>
                        <span class="show-for-sr">Setup</span>
                    </button>
                    <button class="topbar-button-fa button secondary" title="Settings" data-section="settings">
                        <i class="fa fa-cog"></i>
                        <span class="show-for-sr">Settings</span>
                    </button>
                    <button class="topbar-button-fi button" title="One-time Entry" data-section="singleEntry">
                        <i class="fi-play-video"></i>
                        <span class="show-for-sr">One-time Entry</span>
                    </button>
                    <button class="topbar-button-fa button" title="Playlists" data-section="playlists">
                        <i class="fa fa-th" style="margin-top: 2px;"></i>
                        <span class="show-for-sr">Manage Playlists</span>
                    </button>
                    <button id="refresh" class="topbar-button-fa button" title="Refresh">
                        <i class="fa fa-refresh"></i>
                        <span class="show-for-sr">Refresh</span>
                    </button>
                    <span id="lastRefresh" class="hide-for-small-only hide" style="margin-left: 0.5rem;">Last refresh: <span id="lastRefreshTime"></span></span>
                </div>
            </li>
        </ul>
    </div>
    <div class="top-bar-right">
        <ul class="menu">
            <li>
                <div class="input-group show-for-large" style="margin-bottom:0;">
                    <input type="text" id="usernameTopbar" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;" />
                    <div class="input-group-button">
                        <button id="usernameButtonTopbar" class="topbar-button-fa button" title="Save Username" style="border-left:none;">
                            <i class="fa fa-save"></i>
                            <span class="show-for-sr">Save Username</span>
                        </button>
                    </div>
                </div>
                <button class="topbar-button-fi button hide-for-large" title="Enter Username" data-toggle="usernameDropdown" style="border-left:none;">
                    <i class="fi-torso"></i>
                    <span class="show-for-sr">Username Entry</span>
                </button>
                <div id="usernameDropdown" class="dropdown-pane hide-for-large" data-dropdown>
                    <div class="input-group" style="margin-bottom:0;">
                        <input type="text" id="username" class="input-group-field" placeholder="Username" style="margin-right:0;text-align:center;width:100%;" />
                        <div class="input-group-button">
                            <button id="usernameButton" class="topbar-button-fa button" title="Save Username" style="border-left:none;">
                                <i class="fa fa-save"></i>
                                <span class="show-for-sr">Save Username</span>
                            </button>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</nav>
<section id="currentStreams" class="row contentSection"></section>
<section id="setup" class="row contentSection">
    <div class="column">
        <h4><i class="fa fa-arrow-left" title="Back to Followed Streams" style="cursor:pointer;" data-section="currentStreams"></i>&nbsp;Setup</h4>
        <h6><strong>Security Notice</strong></h6>
        <p>This tool involves running a batch script located on your computer. When you click a link using the custom protocol it will run this script. While unlikely, if you click a link elsewhere that uses a protocol with the same name it is possible someone could take advantage of this. Use at your own risk.</p>
        <h6><strong>Prerequisites</strong></h6>
        <ul>
            <li><a href="http://www.videolan.org/vlc/index.html">VLC</a></li>
            <li><a href="http://docs.livestreamer.io/">Livestreamer</a></li>
        </ul>
        <h6><strong>launch.bat</strong></h6>
        <code>set "str=%1</code><br />
        <code>set "var2=%str:*:=%"</code><br />
        <code>livestreamer twitch.tv/%var2%</code><br />
        <h6 style="margin-top:0.5rem;"><strong>Protocol Setup</strong></h6>
        <ol>
            <li>In regedit, find HKEY_CLASSES_ROOT</li>
            <li>Add a key named "livestreamer"</li>
            <li>Set livestreamer's default string to "URL:Livestreamer Protocol"</li>
            <li>Add an empty string to livestreamer called "URL Protocol"</li>
            <li>Add a key to livestreamer named "shell"</li>
            <li>Add a key to shell named "open"</li>
            <li>Add a key to open named "command"</li>
            <li>Set command's default string to the path of launch.bat (see below)</li>
        </ol>
        <p style="margin-top:0.5rem;margin-bottom:0.5rem;">The final structure should look like this:</p>
        <p style="margin-bottom:0;">HKEY_CLASSES_ROOT</p>
        <p style="margin-bottom:0;text-indent:1rem;">livestreamer</p>
        <p style="margin-bottom:0;text-indent:2rem;">(Default) = "URL:Livestreamer Protocol"</p>
        <p style="margin-bottom:0;text-indent:2rem;">URL Protocol = ""</p>
        <p style="margin-bottom:0;text-indent:2rem;">shell</p>
        <p style="margin-bottom:0;text-indent:3rem;">open</p>
        <p style="margin-bottom:0;text-indent:4rem;">command</p>
        <p style="margin-bottom:0;text-indent:5rem;">(Default) = "C:\...\launch.bat" "%1"</p>
    </div>
</section>
<section id="settings" class="row contentSection">
    <div class="column">
        <h4><i class="fa fa-arrow-left" title="Back to Followed Streams" style="cursor:pointer;" data-section="currentStreams"></i>&nbsp;Settings</h4>
    </div>
    <div class="medium-4 columns">
        <div class="input-group">
            <label for="quality" class="input-group-label">Quality</label>
            <select id="quality" class="input-group-field">
                <option value="best">Best</option>
                <option value="source">Source</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
                <option value="mobile">Mobile</option>
                <option value="audio">Audio</option>
            </select>
        </div>
    </div>
    <div class="medium-4 columns">
        <div class="input-group">
            <label for="autoRefresh" class="input-group-label" style="width: 100%">Refresh every 2 minutes</label>
            <input type="checkbox" id="autoRefresh" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
        </div>
    </div>
    <div class="medium-4 columns">
        <div class="input-group" style="margin-bottom:0;">
            <label for="twelveHour" class="input-group-label" style="width: 100%">12-hour time</label>
            <input type="checkbox" id="twelveHour" class="input-group-field" style="height: 40px; width: 40px; margin-right: 0;" />
        </div>
    </div>
</section>
<section id="singleEntry" class="row contentSection">
    <div class="column">
        <h4><i class="fa fa-arrow-left" title="Back to Followed Streams" style="cursor:pointer;" data-section="currentStreams"></i>&nbsp;One-time Entry</h4>
        <div class="input-group" style="margin-bottom:0.5rem;">
            <label for="channelName" class="input-group-label" style="width:6rem;">Channel</label>
            <input type="text"id="channelName" class="input-group-field" placeholder="Channel Name" style="text-align:center;width:100%;" />
            <div class="input-group-button">
                <a id="checkSingleStream" class="button primary disabled" style="width:8.1rem;">
                    <span>Check Stream</span>
                    <img src="http://www.gifstache.com/images/ajax_loader.gif" style="height:25px;margin-top:-0.45rem;margin-bottom:-0.45rem;" />
                </a>
            </div>
        </div>
        <div class="input-group" style="margin-bottom:0;">
            <label for="gameTitle" class="input-group-label" style="width:6rem;">Game</label>
            <input type="text" id="gameTitle" class="input-group-field" placeholder="Game Title" style="text-align:center;width:100%;" />
            <div class="input-group-button">
                <a id="checkGame" class="button primary disabled" style="width:8.1rem;">
                    <span>Check Game</span>
                </a>
            </div>
        </div>
    </div>
</section>
<section id="playlists" class="contentSection">
    <div class="row">
        <div class="small-2 columns"><h4><i class="fa fa-arrow-left" title="Back to Followed Streams" style="cursor:pointer;" data-section="currentStreams"></i>&nbsp;Playlists</h4></div>
        <div class="small-2 columns">
            <h6><strong>Type</strong></h6>
        </div>
        <div class="small-6 columns">
            <h6><strong>Name</strong></h6>
        </div>
        <div class="small-2 columns">
            <h6 class="text-center"><strong>Active</strong></h6>
        </div>
    </div>
    <div id="playlistsTemporary" class="row playlist-row">
        <div class="small-2 columns">
            <div class="button-group">
                <button class="button hollow secondary disabled topbar-button-fa">
                    <i class="fa fa-trash-o"></i>
                    <span class="show-for-sr">Delete Playlist</span>
                </button>
                <button class="button hollow disabled topbar-button-fa">
                    <i class="fa fa-edit"></i>
                    <span class="show-for-sr">Edit Playlist</span>
                </button>
            </div>
        </div>
        <div class="small-2 columns"><span>Temporary</span></div>
        <div class="small-6 columns"><span id="temporaryPlaylistName"></span></div>
        <div class="small-2 columns">
            <div class="switch text-center">
                <input type="radio" id="temporarySwitch" class="switch-input" name="activePlaylist" value="temporary" />
                <label class="switch-paddle" for="temporarySwitch" style="opacity:0.25;cursor:not-allowed;pointer-events:none;">
                    <span class="show-for-sr">Temporary Playlist</span>
                </label>
            </div>
        </div>
    </div>
    <section id="playlistsDefault">
        <div class="row playlist-row">
            <div class="small-2 columns">
                <div class="button-group">
                    <button class="button hollow secondary disabled topbar-button-fa">
                        <i class="fa fa-trash-o"></i>
                        <span class="show-for-sr">Delete Playlist</span>
                    </button>
                    <button class="button hollow disabled topbar-button-fa">
                        <i class="fa fa-edit"></i>
                        <span class="show-for-sr">Edit Playlist</span>
                    </button>
                </div>
            </div>
            <div class="small-2 columns"><span style="font-style:italic;">(default)</span></div>
            <div class="small-6 columns"><span>Followed Channels</span></div>
            <div class="small-2 columns">
                <div class="switch text-center">
                    <input type="radio" id="followedSwitch" class="switch-input" name="activePlaylist" value="followed" />
                    <label class="switch-paddle" for="followedSwitch">
                        <span class="show-for-sr">Followed Channels</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="row playlist-row">
            <div class="small-2 columns">
                <div class="button-group">
                    <button class="button hollow secondary disabled topbar-button-fa">
                        <i class="fa fa-trash-o"></i>
                        <span class="show-for-sr">Delete Playlist</span>
                    </button>
                    <button class="button hollow disabled topbar-button-fa">
                        <i class="fa fa-edit"></i>
                        <span class="show-for-sr">Edit Playlist</span>
                    </button>
                </div>
            </div>
            <div class="small-2 columns"><span style="font-style:italic;">(default)</span></div>
            <div class="small-6 columns"><span>Live Hosts</span></div>
            <div class="small-2 columns">
                <div class="switch text-center">
                    <input type="radio" id="hostsSwitch" class="switch-input" name="activePlaylist" value="hosts" />
                    <label class="switch-paddle" for="hostsSwitch">
                        <span class="show-for-sr">Live Hosts</span>
                    </label>
                </div>
            </div>
        </div>
    </section>
    <section id="playlistsGames"></section>
    <section id="playlistsCustom"></section>
    <div class="row playlist-row">
        <div class="small-2 small-offset-10 columns text-center">
            <button class="button topbar-button-fi" title="New Playlist" data-section="newPlaylist" style="margin-top:4px;margin-bottom:4px;border-left:none;height:32px;width:64px;">
                <i class="fi-plus" style="font-size:24px;"></i>
                <span class="show-for-sr">New Playlist</span>
            </button>
        </div>
    </div>
</section>
<section id="newPlaylist" class="row contentSection">
    <div class="column">
        <h4><i class="fa fa-arrow-left" title="Back to Playlists" style="cursor:pointer;" data-section="playlists"></i>&nbsp;New Playlist</h4>
    </div>
    <div class="column">
        <ul id="newPlaylistTabs" class="tabs" data-tabs>
            <li class="tabs-title is-active"><a href="#newGamePlaylist" aria-selected="true"><i class="fa fa-gamepad"></i>&nbsp;Game</a></li>
            <!-- <li class="tabs-title"><a href="#newCustomPlaylist"><i class="fa fa-cogs"></i>&nbsp;Custom</a></li> -->
        </ul>
        <div class="tabs-content" data-tabs-content="newPlaylistTabs">
            <div class="tabs-panel is-active" id="newGamePlaylist">
                <div class="input-group" style="margin-bottom:0;">
                    <input type="text" id="gamePlaylistTitle" class="input-group-field" placeholder="Search Game Titles" style="text-align:center;width:100%;" />
                    <div class="input-group-button">
                        <a id="checkPlaylistGame" class="button primary disabled" style="width:8.1rem;">
                            <span>Search</span>
                            <img src="http://www.gifstache.com/images/ajax_loader.gif" style="height:25px;margin-top:-0.45rem;margin-bottom:-0.45rem;" />
                        </a>
                    </div>
                </div>
                <div id="gamePlaylistResults" style="margin-top:1rem;"></div>
            </div>
            <!-- <div class="tabs-panel" id="newCustomPlaylist"></div> -->
        </div>
    </div>
</section>
<footer class="row">
    <div class="column">
        <hr />
        <p style="text-align:center;">&copy; <span id="year"></span> <a href="http://www.isaac-west.ca/">Isaac West</a></p>
    </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/foundation/6.1.2/foundation.min.js"></script>
<script>
    (function () {
        $(document).foundation();
        $("#playlistsTemporary").hide();
        $("#singleEntry img, #checkPlaylistGame img").hide();
        $("#year").text(new Date().getFullYear());

        Array.prototype.sortBy = function(properties) {
            var tempArray = properties.split("[").join(".").split("]").join(".").split(".");
            var propArray = [];
            for (var i = 0; i < tempArray.length; i++) {
                if (tempArray[i] !== "") {
                    propArray.push(tempArray[i]);
                }
            }
            var getPropByPropArray = function(object, propArray, index) {
                if (!index) {
                index = 0;
                }
                if (index === propArray.length - 1) {
                    return object[propArray[index]];
                }
                return getPropByPropArray(object[propArray[index]], propArray, ++index);
            }
            this.sort(function(a, b) {
                var aVal = getPropByPropArray(a, propArray);
                var bVal = getPropByPropArray(b, propArray);
                if (typeof aVal === "string" && typeof bVal === "string") {
                    return aVal.toLocaleLowerCase().localeCompare(bVal.toLocaleLowerCase());
                }
                return bVal - aVal;
            });
        };
        
        window.twitchStream = {
            currentUser: localStorage.getItem("twitchStream.currentUser"),
            quality: localStorage.getItem("twitchStream.quality"),
            autoRefresh: localStorage.getItem("twitchStream.autoRefresh"),
            twelveHour: localStorage.getItem("twitchStream.twelveHour"),
            activePlaylist: localStorage.getItem("twitchStream.activePlaylist"),
            gamePlaylists: JSON.parse(localStorage.getItem("twitchStream.gamePlaylists")),
            playlistData: JSON.parse(localStorage.getItem("twitchStream.playlistData")),

            showSection: function(sectionId) {
                var section = $("#" + sectionId);
                if (section.is(":visible")) {
                    $(".contentSection").hide();
                    $("#currentStreams").show();
                } else {
                    $(".contentSection").hide();
                    section.show();
                }
            },

            refresh: function() {
                if (twitchStream.activePlaylist === "game") {
                    $("#refresh i").addClass("fa-spin");
                    twitchStream.getGames(twitchStream.playlistData.title, twitchStream.getGameTitle);
                } else if (twitchStream.activePlaylist === "custom") {
                    //TODO
                } else if (twitchStream.currentUser) {
                    $("#refresh i").addClass("fa-spin");
                    if (twitchStream.activePlaylist === "followed") {
                        twitchStream.getFollowed(twitchStream.currentUser);
                    } else if (twitchStream.activePlaylist === "hosts") {
                        twitchStream.getHosts(twitchStream.currentUser);
                    }
                } else {
                    $("#currentStreams").empty();
                    $("#currentStreams").append(
                        $("<h5/>", {
                            text: "Enter a Username",
                            class: "text-center",
                            style: "font-style:italic;"
                        })
                    );
                    $("#lastRefresh").addClass("hide");
                }
            },

            useTemporaryPlaylist: function() {
                $("#refresh i").addClass("fa-spin");
                $("#playlistsTemporary").show();
                twitchStream.setValue("activePlaylist", twitchStream.temporaryPlaylist.type);
                twitchStream.setValue("playlistData", twitchStream.temporaryPlaylist.data);
                twitchStream.refresh();
                if (twitchStream.activePlaylist === "game") {
                    $("#temporaryPlaylistName").text("Game: " + twitchStream.playlistData.title);
                } else if (twitchStream.activePlaylist === "custom") {
                    //TODO
                }
                $("#temporarySwitch").prop("checked", true);
            },

            getFollowed: function(username) {
                var url = "https://api.twitch.tv/kraken/users/" + username + "/follows/channels";
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        twitchStream.getStreams(result);
                    },
                    error: function() {
                        $("#refresh i").removeClass("fa-spin");
                    }
                });
            },

            getStreams: function(followedStreams) {
                $("#currentStreams").empty();
                if (followedStreams.follows.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Followed Channels"));
                } else {
                    var url = "https://api.twitch.tv/kraken/streams?channel=";

                    followedStreams.follows.forEach(function(item) {
                        url += item.channel.display_name + ",";
                    });

                    url = url.substring(0, url.length - 1);

                    $.ajax({
                        url: url,
                        cache: false,
                        success: function(result) {
                            result.streams.sortBy("channel.display_name");
                            twitchStream.renderStreams(result.streams, "Followed Streams");
                        }
                    });
                }
            },

            renderStreams: function(streams, title) {
                if (streams.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Channels Live"));
                } else {
                    $("#currentStreams").append(twitchStream.rendering.title(title));

                    var now = Date.now();
                    streams.forEach(function(item) {
                        $("#currentStreams").append(
                            twitchStream.rendering.renderFollow(
                                item.channel.display_name,
                                item.channel.status,
                                item.preview.medium,
                                item.game,
                                item.viewers,
                                now
                            )
                        );
                    });

                    $("#currentStreams > div.columns:last-child").addClass("end");
                }

                twitchStream.finishRefresh();
            },

            getHosts: function(username) {
                $("#currentStreams").empty();
                var url = "http://api.twitch.tv/api/users/" + username + "/followed/hosting?callback=?";
                $.getJSON(url, function(data) {
                    twitchStream.renderHosts(data.hosts);
                });
            },

            renderHosts: function(hosts) {
                if (hosts.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Live Hosts"));
                } else {
                    hosts.sortBy("target.viewers");

                    $("#currentStreams").append(twitchStream.rendering.title("Live Hosts"));

                    var now = Date.now();
                    hosts.forEach(function(item) {
                        $("#currentStreams").append(
                            twitchStream.rendering.renderHost(
                                item.display_name,
                                item.target.channel.name,
                                item.target.preview,
                                item.game,
                                item.target.viewers,
                                now
                            )
                        );
                    });

                    $("#currentStreams > div.columns:last-child").addClass("end");
                }

                twitchStream.finishRefresh();
            },

            getGames: function(fragment, success, error) {
                var url = "https://api.twitch.tv/kraken/search/games?q=" + fragment + "&type=suggest&live=true";
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        success(result.games);
                    },
                    error: function() {
                        if (error) {
                            error();
                        }
                    }
                });
            },

            getGameTitle: function(games) {
                $("#currentStreams").empty();
                if (games.length < 1) {
                    $("#currentStreams").append(twitchStream.rendering.error("No Games Found"));
                } else {
                    twitchStream.getGameStreams(games[0].name);
                }
            },

            getGameStreams: function(title) {
                var url = "https://api.twitch.tv/kraken/streams?game=" + title;
                $.ajax({
                    url: url,
                    cache: false,
                    success: function(result) {
                        result.streams.sortBy("viewers");
                        twitchStream.renderStreams(result.streams, title);
                    }
                });
            },

            finishRefresh: function() {
                twitchStream.updateRefreshTimestamp();
                $("#lastRefresh").removeClass("hide");
                $("#refresh i").removeClass("fa-spin");
                $("#currentStreams h6").on("click", function() {
                    $(this).toggleClass("truncate-line-wrap");
                });
            },

            updateRefreshTimestamp: function() {
                var now = new Date();
                var hours = now.getHours();
                if (twitchStream.twelveHour) {
                    if (hours > 12) {
                        hours -= 12;
                    } else if (hours === 0) {
                        hours = 12;
                    }
                }
                var minutes = now.getMinutes();
                if (minutes < 10) {
                    minutes = "0" + minutes;
                }
                $("#lastRefreshTime").text(hours + ":" + minutes);
            },

            initAutoRefresh: function() {
                if (twitchStream.autoRefreshInterval) {
                    clearInterval(twitchStream.autoRefreshInterval);
                }
                if (twitchStream.autoRefresh) {
                    twitchStream.autoRefreshInterval = setInterval(function() {
                            twitchStream.refresh();
                        }, 1000 * 60 * 2
                    );
                }
            },

            setValue: function(key, value) {
                twitchStream[key] = value;
                if (typeof value === "object") {
                    value = JSON.stringify(value);
                }
                localStorage.setItem("twitchStream." + key, value);
            },

            getValue: function(key) {
                if (!twitchStream[key]) {
                    var value = localStorage.getItem("twitchStream." + key);
                    if (value.substring(0, 1) === "{" ||
                        value.substring(0, 1) === "[") {
                        value = JSON.parse(value);
                    }
                    twitchStream[key] = value;
                }
                return twitchStream[key];
            },

            clearValue: function(key) {
                localStorage.removeItem("twitchStream." + key);
                delete twitchStream[key];
            },

            rebindGamePlaylistSwitches: function() {
                $("#playlistsGames input[name=activePlaylist]").off("change");
                $("#playlistsGames input[name=activePlaylist]").on("change", function() {
                    var gameTitle = $(this).val();
                    $("#playlistsTemporary").hide();
                    twitchStream.setValue("activePlaylist", "game");
                    twitchStream.setValue("playlistData", { title: gameTitle });

                    $("#currentStreams").empty();
                    twitchStream.showSection("currentStreams");
                    twitchStream.refresh();
                });
            },

            rendering: {
                title: function(title) {
                    var $div = $("<div/>", {
                        class: "column"
                    })

                    var $h4 = $("<h4/>");
                    if (twitchStream.activePlaylist !== "followed") {
                        $h4.append(
                            $("<i/>", {
                                title: "Back to Followed Streams",
                                class: "fa fa-arrow-left",
                                style: "cursor:pointer;"
                            }).on("click", function() {
                                twitchStream.setValue("activePlaylist", "followed");
                                $("#currentStreams").empty();
                                twitchStream.refresh();
                                $("#playlistsTemporary").hide();
                                $("#followedSwitch").prop("checked", true);
                            })
                        ).append("&nbsp;");
                    }

                    $h4.append(document.createTextNode(title));
                    $div.append($h4);
                    return $div;
                },

                error: function(error) {
                    $("#refresh i").removeClass("fa-spin");
                    return $("<div/>", {
                        class: "column"
                    }).append(
                        $("<h5/>", {
                            text: error,
                            class: "text-center",
                            style: "font-style:italic;margin-top:0.4375rem;"
                        })
                    );
                },

                gamePlaylists: function() {
                    var $playlistsSection = $("#playlistsGames");
                    $playlistsSection.empty();
                    twitchStream.gamePlaylists.forEach(function(item) {
                        $playlistsSection.append(
                            twitchStream.rendering.playlistRow("Game", item, item, true)
                        );
                    });
                },

                playlistRow: function(type, name, key, editDisabled) {
                    var $div = $("<div/>", {
                        class: "row playlist-row"
                    });

                    var $deleteButton = $("<button/>", {
                        class: "button hollow secondary topbar-button-fa"
                    }).append(
                        $("<i/>", {
                            class: "fa fa-trash-o"
                        })
                    ).append(
                        $("<span/>", {
                            text: "Delete Playlist",
                            class: "show-for-sr"
                        })
                    ).on("click", function() {
                        twitchStream.playlists.deletePlaylist("game", key);
                    });

                    var $editButton = $("<button/>", {
                        class: "button hollow topbar-button-fa"
                    }).append(
                        $("<i/>", {
                            class: "fa fa-edit"
                        })
                    ).append(
                        $("<span/>", {
                            text: "Edit Playlist",
                            class: "show-for-sr"
                        })
                    );

                    if (editDisabled) {
                        $editButton.addClass("disabled");
                    }

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<div/>", {
                            class: "button-group"
                        }).append($deleteButton)
                        .append($editButton)
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<span/>", {
                            text: type
                        })
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-6 columns"
                    }).append(
                        $("<span/>", {
                            text: name
                        })
                    ).appendTo($div);

                    $("<div/>", {
                        class: "small-2 columns"
                    }).append(
                        $("<div/>", {
                            class: "switch text-center"
                        }).append(
                            $("<input/>", {
                                type: "radio",
                                id: key.split(" ").join() + "Switch",
                                class: "switch-input",
                                name: "activePlaylist",
                                value: key
                            })
                        ).append(
                            $("<label/>", {
                                class: "switch-paddle",
                                for: key.split(" ").join() + "Switch"
                            }).append(
                                $("<span/>", {
                                    text: name,
                                    class: "show-for-sr"
                                })
                            )
                        )
                    ).appendTo($div);

                    return $div;
                },

                outerDiv: function() {
                    return $("<div/>", {
                        class: "large-3 medium-4 small-12 columns"
                    });
                },

                panel: function() {
                    return $("<div/>", {
                        class: "callout secondary",
                        style: "padding:0.75rem;"
                    });
                },

                preview: function(channelName, src, gameTitle, now) {
                    return $("<a/>", {
                        href: "http://www.twitch.tv/" + channelName
                    }).append(
                        $("<img/>", {
                            src: src + "?" + now,
                            title: gameTitle,
                            style: "margin-bottom:0.5rem;width:100%;height:100%;"
                        })
                    );
                },

                status: function(status) {
                    return $("<h6/>", {
                        text: status,
                        title: status,
                        class: "truncate-line-wrap",
                        style: "margin-bottom:0;"
                    });
                },

                viewers: function(viewers) {
                    return $("<p/>", {
                        text: viewers + " watching ",
                        class: "truncate-line-wrap",
                        style: "margin-bottom:0.5rem;text-align:right;"
                    });
                },

                profileLink: function(channelName) {
                    return $("<a/>", {
                        text: channelName,
                        href: "http://www.twitch.tv/" + channelName + "/profile"
                    });
                },

                buttonsRow: function(channelName) {
                    var $buttonsRow = $("<div/>", {
                        class: "row collapse"
                    });

                    $("<div/>", {
                        class: "small-3 columns"
                    }).appendTo($buttonsRow).append(
                        $("<a/>", {
                            href: "http://www.twitch.tv/" + channelName + "/chat",
                            target: "_blank",
                            class: "button hollow expanded secondary disabled",
                            style: "margin-bottom:0;padding:0.3rem 1rem;"
                        }).append(
                            $("<i/>", {
                                class: "fi-comments",
                                style: "color:#333;font-size:1.7rem;"
                            })
                        )
                    );

                    $("<div/>", {
                        class: "small-9 columns"
                    }).appendTo($buttonsRow).append(
                        $("<a/>", {
                            text: "Launch",
                            href: "livestreamer:" + channelName + " " + twitchStream.quality,
                            class: "button expanded",
                            style: "margin-bottom:0;"
                        })
                    );

                    return $buttonsRow;
                },

                renderFollow: function(channelName, status, preview, gameTitle, viewers, now) {
                    var $div = twitchStream.rendering.outerDiv();
                    var $panel = twitchStream.rendering.panel().appendTo($div);

                    twitchStream.rendering.preview(
                        channelName,
                        preview,
                        gameTitle,
                        now
                    ).appendTo($panel);
                    
                    twitchStream.rendering.status(
                        status
                    ).appendTo($panel);

                    twitchStream.rendering.viewers(
                        viewers
                    ).appendTo($panel)
                        .append(twitchStream.rendering.profileLink(channelName)
                    );

                    twitchStream.rendering.buttonsRow(
                        channelName
                    ).appendTo($panel);

                    return $div;
                },

                renderHost: function(hostName, targetName, preview, gameTitle, viewers, now) {
                    var $div = twitchStream.rendering.outerDiv();
                    var $panel = twitchStream.rendering.panel().appendTo($div);

                    twitchStream.rendering.preview(
                        targetName,
                        preview,
                        gameTitle,
                        now
                    ).appendTo($panel);
                    
                    twitchStream.rendering.status(
                        hostName + " hosting " + targetName
                    ).appendTo($panel);

                    twitchStream.rendering.viewers(
                        viewers
                    ).appendTo($panel)
                        .append(twitchStream.rendering.profileLink(targetName)
                    );

                    twitchStream.rendering.buttonsRow(
                        targetName
                    ).appendTo($panel);

                    return $div;
                }
            },

            singleStream: {
                checkStream: function(channelName) {
                    $("#checkSingleStream span").hide();
                    $("#checkSingleStream img").show();
                    $.ajax({
                        url: "https://api.twitch.tv/kraken/streams?channel=" + channelName,
                        cache: false,
                        success: function(result) {
                            twitchStream.singleStream.updateButton(channelName, result);
                        },
                        error: function() {
                            $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Error").show();
                            $("#checkSingleStream img").hide();
                        }
                    });                    
                },

                updateButton: function(channelName, stream) {
                    if (stream.streams.length > 0) {
                        $("#checkSingleStream")
                            .removeClass("primary")
                            .addClass("success")
                            .prop("href", "livestreamer:" + channelName + " " + twitchStream.quality);
                        $("#checkSingleStream span").text("Launch Stream").show();
                        $("#checkSingleStream img").hide();
                        if (twitchStream.singleStream.timeout) {
                            clearTimeout(twitchStream.singleStream.timeout);
                        }
                        twitchStream.singleStream.timeout = setTimeout(function() {
                                var $button = $("#checkSingleStream");
                                if ($button.hasClass("success")) {
                                    $button.removeClass("success")
                                        .addClass("primary")
                                        .removeAttr("href");
                                    $("#checkSingleStream span").text("Check Stream");
                                }
                            },
                            1000 * 30
                        );
                    } else {
                        $("#checkSingleStream")
                                .removeClass("success")
                                .removeClass("primary")
                                .addClass("alert")
                                .removeAttr("href");
                            $("#checkSingleStream span").text("Not Live").show();
                            $("#checkSingleStream img").hide();
                    }
                }
            },

            playlists: {
                selectActive: function () {
                    if (twitchStream.activePlaylist) {
                        if (twitchStream.activePlaylist === "game") {
                            $("input[name=activePlaylist][value='" + twitchStream.playlistData.title + "']").attr("checked", "checked");
                        } else {
                            $("input[name=activePlaylist][value='" + twitchStream.activePlaylist + "']").attr("checked", "checked");
                        }
                    } else {
                        $("#followedSwitch").attr("checked", "checked");
                        twitchStream.setValue("activePlaylist", "followed");
                    }
                },

                searchGames: function() {
                    $("#checkPlaylistGame span").hide();
                    $("#checkPlaylistGame img").show();

                    twitchStream.getGames($("#gamePlaylistTitle").val(),
                        twitchStream.playlists.showGameResults,
                        function() {
                            $("#checkPlaylistGame img").hide();
                            $("#checkPlaylistGame span").show();
                        }
                    );
                },

                showGameResults: function(games) {
                    $("#checkPlaylistGame img").hide();
                    $("#checkPlaylistGame span").show();
                    
                    var $div = $("#gamePlaylistResults");
                    $div.empty();

                    games.forEach(function(item) {
                        var $row = $("<div/>", {
                            class: "row playlist-row"
                        }).appendTo($div);

                        $("<div/>", {
                            class: "small-8 medium-9 large-10 columns media-object",
                            style: "margin-bottom:0;"
                        }).append(
                            $("<div/>", {
                                class: "media-object-section"
                            }).append(
                                $("<img/>", {
                                    src: item.box.medium,
                                    alt: item.name,
                                    style: "height:5rem;"
                                })
                            )
                        ).append(
                            $("<div/>", {
                                class: "media-object-section"
                            }).append(
                                $("<h6/>", {
                                    text: item.name,
                                    style: "line-height:5rem;margin-bottom:0;"
                                })
                            )
                        ).appendTo($row);

                        var $button = $("<button/>", {
                            text: "Select Game",
                            class: "button expanded",
                            style: "margin-top:1rem;"
                        });

                        $("<div/>", {
                            class: "small-4 medium-3 large-2 columns"
                        }).append(
                            $button
                        ).appendTo($row);

                        $button.on("click", function() {
                            twitchStream.playlists.newGamePlaylist(item.name);
                        });
                    });
                },

                newGamePlaylist: function(gameTitle) {
                    if (!twitchStream.gamePlaylists) {
                        twitchStream.gamePlaylists = [];
                    }
                    if (twitchStream.gamePlaylists.indexOf(gameTitle) === -1) {
                        twitchStream.gamePlaylists.push(gameTitle);
                        twitchStream.gamePlaylists.sort(function(a, b) {
                            return a.toLocaleLowerCase().localeCompare(b.toLocaleLowerCase());
                        });
                        twitchStream.setValue("gamePlaylists", twitchStream.gamePlaylists);
                        twitchStream.rendering.gamePlaylists();
                    }
                    $("input[name=activePlaylist][value='" + gameTitle + "']").attr("checked", "checked");
                    twitchStream.showSection("playlists");
                    twitchStream.rebindGamePlaylistSwitches();

                    twitchStream.setValue("activePlaylist", "game");
                    twitchStream.setValue("playlistData", { title: gameTitle });
                    twitchStream.refresh();
                },

                deletePlaylist: function(type, name) {
                    if (type === "game") {
                        var index = twitchStream.gamePlaylists.indexOf(name);
                        if (index !== -1) {
                            if ($("input[name=activePlaylist][value='" + name + "']").is(":checked")) {
                                twitchStream.setValue("activePlaylist", "followed");
                                twitchStream.refresh();
                            }
                            twitchStream.gamePlaylists.splice(index, 1);
                            twitchStream.setValue("gamePlaylists", twitchStream.gamePlaylists);
                            
                            twitchStream.rendering.gamePlaylists();
                            twitchStream.rebindGamePlaylistSwitches();
                            twitchStream.playlists.selectActive();
                        }
                    } else if (type === "custom") {
                        //TODO
                    }
                }
            }
        };

        if (!twitchStream.gamePlaylists) {
            twitchStream.setValue("gamePlaylists", []);
        }

        twitchStream.showSection("currentStreams");
        twitchStream.rendering.gamePlaylists();

        if (twitchStream.currentUser) {
            $("#username").val(twitchStream.currentUser);
            $("#usernameTopbar").val(twitchStream.currentUser);
        }

        if (twitchStream.quality) {
            $("#quality").val(twitchStream.quality);
        } else {
            $("#quality").val("best");
            twitchStream.setValue("quality", "best");
        }

        if (twitchStream.autoRefresh) {
            $("#autoRefresh").prop("checked", true);
            twitchStream.initAutoRefresh();
        }

        if (twitchStream.twelveHour) {
            $("#twelveHour").prop("checked", true);
        }

        twitchStream.playlists.selectActive();

        $("[data-section]").on("click", function() {
            twitchStream.showSection($(this).data("section"));
        });

        $("#usernameButton").on("click", function() {
            $("#usernameDropdown").foundation("close");
        });

        $("#usernameButton, #usernameButtonTopbar").on("click", function() {
            var username = $("#username").val();
            twitchStream.setValue("currentUser", username);
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#username").on("keyup", function() {
            if (Foundation.Keyboard.parseKey(event) === "ENTER") {
                $("#usernameButton").trigger("click");
                return;
            }
            $("#usernameTopbar").val($(this).val());
        });

        $("#usernameTopbar").on("keyup", function() {
            if (Foundation.Keyboard.parseKey(event) === "ENTER") {
                $("#usernameButtonTopbar").trigger("click");
                return;
            }
            $("#username").val($(this).val());
        });

        $("#quality").on("change", function() {
            var quality = $(this).val();
            twitchStream.setValue("quality", quality);
            twitchStream.refresh();
            twitchStream.initAutoRefresh();
        });

        $("#autoRefresh").on("change", function() {
            var autoRefresh = $(this).is(":checked");
            if (autoRefresh) {
                localStorage.setItem("twitchStream.autoRefresh", autoRefresh);
            } else {
                localStorage.removeItem("twitchStream.autoRefresh");
            }
            twitchStream.autoRefresh = autoRefresh;
            if (autoRefresh) {
                twitchStream.initAutoRefresh();
                twitchStream.refresh();
            } else {
                clearInterval(twitchStream.autoRefreshInterval);
            }
        });

        $("#twelveHour").on("change", function() {
            var twelveHour = $(this).is(":checked");
            if (twelveHour) {
                localStorage.setItem("twitchStream.twelveHour", twelveHour);
            } else {
                localStorage.removeItem("twitchStream.twelveHour");
            }
            twitchStream.twelveHour = twelveHour;
            if (!$("#lastRefresh").hasClass("hide")) {
                twitchStream.updateRefreshTimestamp();
            }
        });

        $("#channelName").on("keyup", function(event) {
            if (Foundation.Keyboard.parseKey(event) === "ENTER") {
                $("#checkSingleStream").trigger("click");
                return;
            }

            $("#checkSingleStream")
                .removeClass("success")
                .removeClass("alert")
                .addClass("primary")
                .removeAttr("href");
            $("#checkSingleStream span").text("Check Stream").show();
            $("#checkSingleStream img").hide();

            if ($(this).val() === "") {
                $("#checkSingleStream").addClass("disabled");
            } else {
                $("#checkSingleStream").removeClass("disabled");
            }
        });

        $("#checkSingleStream").on("click", function() {
            var $button = $("#checkSingleStream");
            if ($button.hasClass("primary") || $button.hasClass("alert")) {
                twitchStream.singleStream.checkStream($("#channelName").val());
            }
        });

        $("#gameTitle").on("keyup", function() {
            if (Foundation.Keyboard.parseKey(event) === "ENTER") {
                $("#checkGame").trigger("click");
                return;
            }
            if ($(this).val() === "") {
                $("#checkGame").addClass("disabled");
            } else {
                $("#checkGame").removeClass("disabled");
            }
        });

        $("#checkGame").on("click", function() {
            twitchStream.temporaryPlaylist = {
                type: "game",
                data: {
                    title: $("#gameTitle").val()
                }
            };
            $("#currentStreams").empty();
            twitchStream.showSection("currentStreams");
            twitchStream.useTemporaryPlaylist();
        });

        $("#temporarySwitch").on("click", function(event) {
            event.preventDefault();
        });

        $("#playlistsDefault input[name=activePlaylist]").on("change", function() {
            var activePlaylist = $(this).val();
            $("#playlistsTemporary").hide();
            twitchStream.setValue("activePlaylist", activePlaylist);

            $("#currentStreams").empty();
            twitchStream.showSection("currentStreams");
            twitchStream.refresh();
        });

        twitchStream.rebindGamePlaylistSwitches();

        $("#gamePlaylistTitle").on("keyup", function() {
            if (Foundation.Keyboard.parseKey(event) === "ENTER") {
                $("#checkPlaylistGame").trigger("click");
                return;
            }
            if ($(this).val() === "") {
                $("#checkPlaylistGame").addClass("disabled");
            } else {
                $("#checkPlaylistGame").removeClass("disabled");
            }
        });

        $("#checkPlaylistGame").on("click", function() {
            if ($("#checkPlaylistGame img").is(":hidden")) {
                twitchStream.playlists.searchGames();
            }
        });

        $("#refresh").on("click", function() {
            twitchStream.initAutoRefresh();
            twitchStream.refresh();
            if ($("#currentStreams").is(":hidden")) {
                $("#currentStreams").empty();
                twitchStream.showSection("currentStreams");
            }
        });

        twitchStream.refresh();
    })();
</script>
</body>
</html>
